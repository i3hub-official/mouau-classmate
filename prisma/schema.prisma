// ===========================================================
// MOUAU CLASSMATE - PRISMA SCHEMA (Updated & Complete)
// Identity • E-Learning • Progress • Portfolio • Examinations
// ===========================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================================
// ENUMS (All grouped at the top for clarity)
// ===========================================================

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum Grade {
  A
  B
  C
  D
  E
  F
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  SECURITY
  REMINDER
  GRADE
}

enum AuditAction {
  USER_REGISTERED
  USER_LOGGED_IN
  USER_LOGGED_OUT
  EMAIL_VERIFIED
  PROFILE_UPDATED
  STUDENT_REGISTERED
  ENROLLMENT_CREATED
  ASSIGNMENT_SUBMITTED
  PORTFOLIO_CREATED
  COURSE_CREATED
  ASSIGNMENT_CREATED
  GRADE_ASSIGNED
  EXAM_RESULT_PUBLISHED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET
  SESSION_REFRESHED
  SESSION_INVALIDATED
  NOTIFICATION_SENT
  SYSTEM_CONFIG_UPDATED
  SUSPICIOUS_ACTIVITY_DETECTED
  RATE_LIMIT_EXCEEDED
  RESEND_VERIFICATION_REQUESTED
  USER_LOGIN_FAILED
  EXPORT_TRANSCRIPT
  DATA_EXPORT_REQUESTED
  ACCOUNT_DELETION_REQUESTED
  ACCOUNT_DELETION
  ATTENDANCE_MARKED
  EXAM_RESULT_RECORDED
  EXAM_RESULT_UPDATED
  COURSE_COMPLETED
  ACCOUNT_DEACTIVATED
  ACCOUNT_REACTIVATED
  ACCOUNT_ACTIVATED
  EXAM_COMPLETED
  COURSE_ENROLLED
  GRADE_RECEIVED
  PASSWORD_CHANGED
  STUDENT_PROFILE_UPDATED
  EMAIL_UPDATED
  AUTH_ERROR
  NOTIFICATION_SETTINGS_UPDATED
  ACCOUNT_DELETED
  SESSION_TERMINATED
  SESSION_VALIDATION_FAILED
  SUSPICIOUS_ACTIVITY
  SESSION_VALIDATOR_ERROR
  MIDDLEWARE_FAILURE
  VALIDATOR_ERROR
}

enum ResourceType {
  USER
  STUDENT
  TEACHER
  ADMIN
  COURSE
  LECTURE
  ASSIGNMENT
  ENROLLMENT
  PORTFOLIO
  SESSION
  NOTIFICATION
  ATTENDANCE
  EXAM
  EXAM_RESULT
}

enum SessionSecurityLevel {
  LOW
  MEDIUM
  HIGH
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum ExamType {
  PHYSICAL
  ONLINE
  HYBRID
}

enum ExamFormat {
  THEORY
  PRACTICAL
  OBJECTIVE
  ORAL
  TAKE_HOME
  PROJECT_BASED
}

enum ExamRemark {
  EXCELLENT
  VERY_GOOD
  GOOD
  FAIR
  PASS
  FAIL
  ABSENT
  MALPRACTICE
}

// ===========================================================
// 1. USER & AUTHENTICATION (NextAuth compatible)
// ===========================================================

model User {
  id                        String    @id @default(uuid())
  name                      String?
  email                     String    @unique(map: "users_email_key")
  emailVerified             DateTime?
  passportUrl               String?
  role                      Role      @default(STUDENT)
  isActive                  Boolean   @default(false)
  lastLoginAt               DateTime?
  loginCount                Int       @default(0)
  failedLoginAttempts       Int       @default(0)
  lastFailedLoginAt         DateTime?
  accountLocked             Boolean   @default(false)
  lockedUntil               DateTime?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  passwordHash              String?
  greeting                  String?   @default("Welcome back!")
  greetingNextChange        DateTime?
  emailVerificationRequired Boolean   @default(true)
  emailVerificationAttempts Int       @default(0)
  metadata                  Json?

  // Auth
  accounts Account[]
  sessions Session[]

  // Profiles (1-to-1)
  student Student?
  teacher Teacher?
  admin   Admin?

  // Relations
  auditLogs      AuditLog[]
  notifications  Notification[]
  resetTokens    PasswordResetToken[]
  metrics        Metric[]
  userActivities UserActivity[]
  securityEvents SecurityEvent[]
  preferences    UserPreferences?

  // Reverse relations for convenience
  markedAttendances Attendance[]    @relation("AttendanceMarkedBy")
  updatedConfigs    SystemConfig[]  @relation("SystemConfigUpdatedBy")
  resolvedEvents    SecurityEvent[] @relation("SecurityEventResolvedBy")
  examResults       ExamResult[]

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([isActive])
  @@index([accountLocked])
  @@map("users")
}

// ===========================================================
// NextAuth Models
// ===========================================================

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id                String               @id @default(cuid())
  sessionToken      String               @unique
  userId            String
  expires           DateTime
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  deviceFingerprint String?
  userAgent         String?
  ipAddress         String?
  securityLevel     SessionSecurityLevel @default(MEDIUM)
  lastAccessedAt    DateTime             @default(now())
  refreshCount      Int                  @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
  @@index([deviceFingerprint])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expires   DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  ipAddress String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expires])
  @@map("password_reset_tokens")
}

// ===========================================================
// 2. PROFILES
// ===========================================================

model Student {
  id            String  @id @default(uuid())
  matricNumber  String  @unique
  jambRegNumber String  @unique
  nin           String? @unique

  surname     String  @db.Text
  firstName   String  @db.Text
  otherName   String? @db.Text
  gender      Gender?
  phone       String  @unique @db.Text
  passportUrl String? @db.Text
  email       String  @unique @db.Text

  department     String         @db.Text
  course         String         @default("") @db.Text
  college        String         @db.Text
  state          String         @db.Text
  lga            String         @db.Text
  maritalStatus  MaritalStatus? @default(SINGLE)
  dateEnrolled   DateTime       @default(now())
  admissionYear  Int?
  dateOfBirth    DateTime?
  isActive       Boolean        @default(true)
  lastActivityAt DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Encrypted search
  emailSearchHash   String? @unique
  phoneSearchHash   String? @unique
  matricSearchHash  String? @unique
  jambRegSearchHash String? @unique
  ninSearchHash     String? @unique

  // Relations
  userId                String                 @unique
  user                  User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  enrollments           Enrollment[]
  portfolios            Portfolio[]
  submissions           Submission[]
  assignmentSubmissions AssignmentSubmission[]
  attendances           Attendance[]
  examResults           ExamResult[]

  @@index([matricNumber])
  @@index([department, admissionYear])
  @@index([isActive, admissionYear])
  @@index([email])
  @@index([phone])
  @@map("students")
}

model Teacher {
  id             String    @id @default(uuid())
  teacherId      String    @unique
  surname        String    @db.Text
  firstName      String    @db.Text
  otherName      String?   @db.Text
  gender         Gender?
  phone          String    @unique @db.Text
  email          String    @unique @db.Text
  institution    String    @db.Text
  department     String    @db.Text
  qualification  String?   @db.Text
  specialization String?   @db.Text
  experience     String?   @db.Text
  title          String?   @db.Text
  dateJoined     DateTime  @default(now())
  isActive       Boolean   @default(true)
  passportUrl    String?   @db.Text
  lastActivityAt DateTime?
  updatedAt      DateTime  @updatedAt

  emailSearchHash     String? @unique
  phoneSearchHash     String? @unique
  teacherIdSearchHash String? @unique

  userId            String       @unique
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  instructedCourses Course[]     @relation("CourseInstructor")
  createdCourses    Course[]     @relation("CourseCreator")
  assignments       Assignment[]

  @@index([teacherId])
  @@index([department])
  @@map("teachers")
}

model Admin {
  id             String    @id @default(uuid())
  adminId        String    @unique
  surname        String    @db.Text
  firstName      String    @db.Text
  otherName      String?   @db.Text
  gender         Gender?
  phone          String    @unique @db.Text
  email          String    @unique @db.Text
  department     String    @db.Text
  institution    String    @db.Text
  qualification  String?   @db.Text
  specialization String?   @db.Text
  experience     String?   @db.Text
  dateJoined     DateTime  @default(now())
  isActive       Boolean   @default(true)
  passportUrl    String?   @db.Text
  lastActivityAt DateTime?
  updatedAt      DateTime  @updatedAt

  emailSearchHash     String? @unique
  phoneSearchHash     String? @unique
  teacherIdSearchHash String? @unique

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

// ===========================================================
// 3. ACADEMIC STRUCTURE
// ===========================================================

model Course {
  id            String   @id @default(uuid())
  code          String   @unique
  title         String
  description   String?
  credits       Int      @default(3)
  level         Int      @default(100)
  semester      Int      @default(1)
  courseOutline String?
  isActive      Boolean  @default(true)
  color         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  instructorId String?
  instructor   Teacher? @relation("CourseInstructor", fields: [instructorId], references: [id])
  creatorId    String?
  creator      Teacher? @relation("CourseCreator", fields: [creatorId], references: [id])

  lectures    Lecture[]
  enrollments Enrollment[]
  assignments Assignment[]
  portfolios  Portfolio[]
  attendances Attendance[]
  exams       Exam[]
  examResults ExamResult[]

  @@index([code])
  @@index([level, semester, isActive])
  @@index([instructorId])
  @@map("courses")
}

model Lecture {
  id          String    @id @default(uuid())
  title       String
  description String?
  content     Json?
  duration    Int?
  orderIndex  Int       @default(0)
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  courseId    String
  course      Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  submissions Submission[]
  attendances Attendance[]

  @@index([courseId])
  @@index([orderIndex])
  @@map("lectures")
}

model Exam {
  id          String  @id @default(cuid())
  title       String
  description String?
  courseId    String
  course      Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  date       DateTime
  duration   Int        @default(180)
  totalMarks Int        @default(70)
  venue      String     @default("TBA")
  type       ExamType   @default(PHYSICAL)
  format     ExamFormat @default(THEORY)

  isPublished Boolean   @default(false)
  publishedAt DateTime?
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  results ExamResult[]

  @@index([courseId])
  @@index([date])
  @@index([isPublished])
  @@map("exams")
}

// ===========================================================
// NEW: Exam Results
// ===========================================================

model ExamResult {
  id        String  @id @default(uuid())
  examId    String
  exam      Exam    @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  score       Float?
  percentage  Float? // Auto-calculated: (score / totalMarks) * 100
  grade       Grade?
  remark      ExamRemark @default(PASS)
  isPublished Boolean    @default(false)
  publishedAt DateTime?

  recordedBy String?
  recorder   User?    @relation(fields: [recordedBy], references: [id])
  recordedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Optional fields
  scriptUrl String?
  feedback  String?

  @@unique([examId, studentId])
  @@index([studentId])
  @@index([courseId])
  @@index([examId])
  @@index([isPublished])
  @@index([grade])
  @@map("exam_results")
}

// ===========================================================
// ENROLLMENTS, ASSIGNMENTS, etc.
// ===========================================================

model Enrollment {
  id             String    @id @default(uuid())
  studentId      String
  courseId       String
  dateEnrolled   DateTime  @default(now())
  isCompleted    Boolean   @default(false)
  completionDate DateTime?
  grade          Grade?
  score          Float?
  progress       Float     @default(0)
  lastAccessedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([courseId, isCompleted])
  @@map("enrollments")
}

model Assignment {
  id                  String    @id @default(uuid())
  title               String
  description         String?
  instructions        String?
  dueDate             DateTime
  maxScore            Int       @default(100)
  weight              Float     @default(1.0)
  allowedAttempts     Int       @default(1)
  assignmentUrl       String?
  isPublished         Boolean   @default(false)
  allowLateSubmission Boolean   @default(false)
  scheduledAt         DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  deletedAt           DateTime?

  courseId    String
  course      Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacherId   String?
  teacher     Teacher?               @relation(fields: [teacherId], references: [id])
  submissions AssignmentSubmission[]

  @@index([courseId])
  @@index([dueDate])
  @@map("assignments")
}

model AssignmentSubmission {
  id            String    @id @default(uuid())
  submissionUrl String?
  content       String?
  submittedAt   DateTime  @default(now())
  score         Float?
  feedback      String?
  isGraded      Boolean   @default(false)
  isLate        Boolean   @default(false)
  attemptNumber Int       @default(1)
  gradedAt      DateTime?

  studentId    String
  student      Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@unique([studentId, assignmentId, attemptNumber])
  @@index([assignmentId, isGraded])
  @@map("assignment_submissions")
}

model Submission {
  id          String   @id @default(uuid())
  content     Json?
  submittedAt DateTime @default(now())
  isGraded    Boolean  @default(false)
  score       Float?
  feedback    String?

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lectureId String
  lecture   Lecture @relation(fields: [lectureId], references: [id], onDelete: Cascade)

  @@unique([studentId, lectureId])
  @@map("submissions")
}

model Portfolio {
  id           String   @id @default(uuid())
  title        String
  description  String?
  projectUrl   String?
  imageUrl     String?
  technologies String[]
  isPublished  Boolean  @default(false)
  submittedAt  DateTime @default(now())
  updatedAt    DateTime @updatedAt

  courseId  String
  course    Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([isPublished])
  @@map("portfolios")
}

model Attendance {
  id           String           @id @default(uuid())
  studentId    String
  courseId     String
  lectureId    String
  status       AttendanceStatus @default(PRESENT)
  markedAt     DateTime         @default(now())
  markedBy     String?
  markedByUser User?            @relation("AttendanceMarkedBy", fields: [markedBy], references: [id])
  notes        String?
  verified     Boolean          @default(false)
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lecture Lecture @relation(fields: [lectureId], references: [id], onDelete: Cascade)

  @@unique([studentId, lectureId])
  @@index([courseId])
  @@index([status])
  @@index([verified])
  @@map("attendance")
}

// ===========================================================
// AUDIT, SECURITY, NOTIFICATIONS
// ===========================================================

model AuditLog {
  id            String                @id @default(uuid())
  userId        String?
  user          User?                 @relation(fields: [userId], references: [id])
  action        AuditAction
  resourceType  ResourceType?
  resourceId    String?
  details       Json?
  ipAddress     String?
  userAgent     String?
  securityLevel SessionSecurityLevel?
  createdAt     DateTime              @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  actionUrl String?
  createdAt DateTime         @default(now())
  readAt    DateTime?
  priority  Int              @default(1)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model SystemConfig {
  id            String   @id @default(uuid())
  key           String   @unique
  value         String
  description   String?
  category      String   @default("general")
  isPublic      Boolean  @default(false)
  updatedAt     DateTime @updatedAt
  updatedBy     String?
  updatedByUser User?    @relation("SystemConfigUpdatedBy", fields: [updatedBy], references: [id])

  @@index([category])
  @@map("system_configs")
}

model SecurityEvent {
  id             String    @id @default(uuid())
  userId         String?
  user           User?     @relation(fields: [userId], references: [id])
  eventType      String
  severity       String    @default("medium")
  description    String
  ipAddress      String?
  userAgent      String?
  metadata       Json?
  resolved       Boolean   @default(false)
  resolvedAt     DateTime?
  resolvedBy     String?
  resolvedByUser User?     @relation("SecurityEventResolvedBy", fields: [resolvedBy], references: [id])
  createdAt      DateTime  @default(now())

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("security_events")
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  emailNotifications  Boolean @default(true)
  pushNotifications   Boolean @default(true)
  assignmentReminders Boolean @default(true)
  gradeAlerts         Boolean @default(true)
  lectureReminders    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

model NINCache {
  id               String   @id @default(cuid())
  nin              String   @unique
  surname          String
  firstName        String
  otherName        String?
  gender           String
  dateOfBirth      String
  phoneNumber      String
  state            String?
  lga              String?
  residenceAddress String?
  photo            String?
  firstVerified    DateTime
  lastVerified     DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([nin])
  @@index([phoneNumber])
  @@map("nin_cache")
}

model Metric {
  id        String   @id @default(uuid())
  name      String
  value     Float
  tags      Json?
  timestamp DateTime @default(now())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])

  @@index([name])
  @@index([timestamp])
  @@map("metrics")
}

model RateLimit {
  id          String   @id @default(uuid())
  key         String
  count       Int      @default(1)
  windowStart DateTime
  windowEnd   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, windowStart])
  @@map("rate_limits")
}

model UserActivity {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action       String
  resourceType String?
  resourceId   String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("user_activities")
}

model RequestLog {
  id              String   @id @default(cuid())
  requestId       String
  method          String
  path            String
  ipAddress       String
  userId          String?
  userAgent       String?
  isAuthenticated Boolean
  threatScore     Int      @default(0)
  securityLevel   String   @default("low")
  ipIntelligence  Json?
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([createdAt])
  @@index([ipAddress])
  @@index([userId])
  @@index([threatScore])
}

model DataProcessingLog {
  id             String   @id @default(cuid())
  requestId      String
  userId         String?
  timestamp      DateTime
  method         String
  path           String
  ipAddress      String
  country        String
  jurisdiction   Json
  dataCategories String[]
  legalBasis     String
  consentGiven   Boolean
  retentionDays  Int
  purpose        String
  createdAt      DateTime @default(now())

  @@index([timestamp])
  @@index([userId])
  @@index([country])
  @@index([legalBasis])
}
